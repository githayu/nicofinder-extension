var BG={state:{},storage:{local:{},cache:{}},init:function(){chrome.contextMenus.create({title:"\u52d5\u753bID\u3092\u30b3\u30d4\u30fc",type:"normal",contexts:["link"],documentUrlPatterns:["http://*.nicovideo.jp/*"],onclick:function(e){var t=e.linkUrl.match(Nicofinder.Define.Regexp.Views)[3],n=document.createRange(),i=document.createElement("p");i.setAttribute("id","clip-board"),i.innerText=t,document.body.appendChild(i),n.selectNode(i),window.getSelection().addRange(n),document.execCommand("copy"),window.getSelection().removeAllRanges(),document.body.removeChild(i)}}),chrome.storage.local.get(["redirect"],function(e){BG.storage.local=e}),chrome.storage.onChanged.addListener(function(e,t){for(var n in e)BG.storage[t][n]=e[n].newValue}),chrome.webRequest.onBeforeRequest.addListener(function(e){var t,n=Nicofinder.fn.url_vars_decode(function(){var t=e.url.split("?");return"?"+t[t.length-1]}());return 1==n.nicoview?!1:(t=e.url.match(Nicofinder.Define.Regexp.Views))&&(BG.state.type=t[2],BG.state.id=t[3],BG.storage.local.redirect)?{redirectUrl:[Nicofinder.Define.Host.URL,BG.state.type,BG.state.id].join("/")}:void 0},{urls:["http://*.nicovideo.jp/*"],types:["main_frame"]},["blocking"]),chrome.webRequest.onBeforeRequest.addListener(function(e){return e.url.startsWith("http://res.nimg.jp/js/watch/player/player.js")?{cancel:!0}:void 0},{urls:["*://*.nicofinder.net/*","http://*.nimg.jp/*"],types:["script"]},["blocking"]),chrome.tabs.onUpdated.addListener(function(e,t,n){(Nicofinder.Define.Regexp.Niconico.test(n.url)||Nicofinder.Define.Regexp.Nicofinder.test(n.url))&&chrome.pageAction.show(e)}),chrome.runtime.onMessage.addListener(function(e,t,n){var i={};for(var o in e)switch(o){case"get":for(var r=0;r<e.get.length;r++)0<=e.get.indexOf("type")&&(i.type=BG.state.type),0<=e.get.indexOf("id")&&(i.id=BG.state.id),0<=e.get.indexOf("lastinfo")&&(void 0!==typeof BG.storage.cache.lastinfo?i.lastinfo=BG.storage.cache.lastinfo:i.lastinfo=!1);break;case"set":for(var c=0;c<e.set.length;c++)switch(e.set[c][0]){case"lastinfo":BG.storage.cache.lastinfo=e.set[c][1],i=!0}}n(i)})}};$(function(){BG.init()});