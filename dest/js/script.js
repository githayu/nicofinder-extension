var Nico={},DATA={},Player={};Nico.player={state:{getflv:!1,type:"html5",command_panel:!1,comment:{lastSend:null}},init:function(){Player.watch=document.getElementById("player"),Player.flash=document.getElementById("external_nico_0"),this.video(),$("#comment_anonymity_post").prop("checked",Nico.storage.current.player_setting_v2.comment_anonymity_post).parent().removeClass("hide"),Player.watch.addEventListener("optionchange",function(e){Nico.storage.init("player_setting_v2")},!1),Player.watch.addEventListener("navigate",function(e){DATA=$.extend({},DATA,e.detail),Nico.player.video()},!1),$("#player").on("change",".player-command-panel input",function(){var e=Nico.player.command.change($(this).val());Nico.player.command.output(e)}),$(".player-command-input").on("keyup blur",function(e){if(!([8,32,46,37,38,39,40].indexOf(e.which)>=0)){var t=Nico.player.command.normalization($(this).val());Nico.player.command.output(t)}}),$(".player-command-input").on("focus",function(){$(".player-command-panel").addClass("show"),$(document).click(function(e){$.contains($("#player").get(0),e.target)||$(".player-command-panel").removeClass("show")})}),$(".player-comment-send").on("click",function(){switch(Nico.player.state.type){case"html5":if(!Player.html5)return;var e=Player.html5.currentTime;break;case"flash":if(void 0===Player.flash.ext_getPlayheadTime)return;var e=Player.flash.ext_getPlayheadTime()}Nico.player.comment.check($(".player-comment-input").val(),$(".player-command-input").val(),e)})},video:function(){var e={v:"1"==DATA.video.channel?DATA.video.channel_thread:DATA.video.id};"flv"===DATA.video.movie_type&&(e.eco=1),Nico.api.flGetRequest("getflv",e).done(function(e){if(DATA.getflv=Nico.fn.parse_str(e),"1"==DATA.getflv.closed)console.warn(DATA.getflv),$(Player.watch).addClass("logout");else{Nico.player.state.getflv=!0;var t=DATA.video.channel?DATA.video.channel_thread:DATA.video.id,a={watch_harmful:1};"flv"===DATA.video.movie_type&&(a.eco=1),$.get(["http://www.nicovideo.jp/watch/",t,"?",$.param(a)].join("")).done(function(){$(Player.watch).addClass("login").attr({"data-premium":DATA.getflv.is_premium,"data-src":DATA.getflv.url}),Nico.player.state.command_panel||Nico.player.command.init()}).fail(function(e){console.error(e)})}}).fail(function(e){console.warn(e)})},command:{regExp:{position:/^ue$|^shita$|^naka$/g,color:/^white$|^red$|^pink$|^orange$|^yellow$|^green$|^cyan$|^blue$|^purple$|^black$|^white2$|^niconicowhite$|^red2$|^truered$|^pink2$|^orange2$|^passionorange$|^yellow2$|^madyellow$|^green2$|^elementalgreen$|^cyan2$|^blue2$|^marineblue$|^purple2$|^nobleviolet$|^black2$|^#[A-za-z0-9]{6}$/g,size:/^big$|^medium$|^small$/g,advanced:/^full$|^ender$|^patissier$|^invisible$|^184$|^nicofinder$/g},init:function(){Nico.player.state.command_panel=!0;var e={left:$("<div>").addClass("command-panel-left"),right:$("<div>").addClass("command-panel-right")},t={size:[["\u5927","big",!1],["\u4e2d","medium",!0],["\u5c0f","small",!1]],position:[["\u4e0a","ue",!1],["\u81ea\u52d5","naka",!0],["\u4e0b","shita",!1]]},a=[["white","red","pink","orange","yellow","green","cyan","blue","purple","black"],["white2","red2","pink2","orange2","yellow2","green2","cyan2","blue2","purple2","black2"]];for(var n in t){$(e.left).append($("<fieldset>").attr("name",n).addClass("command-"+n));for(var r="advanced"!==n?"radio":"checkbox",o=0;o<t[n].length;o++)$(e.left).find(".command-"+n).append($("<label>").addClass(t[n][o][1]).append($("<input>").attr({type:r,name:n,value:t[n][o][1]}).prop("checked",t[n][o][2])).append($("<div>").text(t[n][o][0])))}for(var o=0;o<a.length;o++)if(0!=Player.watch.dataset.premium||1!==o){$(e.right).append($("<fieldset>").attr("name","color").addClass("command-color"));for(var n=0;n<a[o].length;n++){var i="white"===a[o][n]?!0:!1;$(e.right).find(".command-color").eq(o).append($("<label>").addClass(a[o][n]).append($("<input>").attr({type:"radio",name:"color",value:a[o][n]}).prop("checked",i)).append($("<div>")))}}1==Player.watch.dataset.premium&&$(e.right).find(".command-color").last().append($("<input>").addClass("hex").attr({type:"color",name:"color"})),$(".player-comment-form").append($("<div>").addClass("player-command-panel").append(e.left).append(e.right))},output:function(e){/^#[A-za-z0-9]{6}$/.test(e.color)?($(".player-command-panel").find("input[name=color]").not(".hex").val([]),$(".player-command-panel").find("input.hex").addClass("active")):($(".player-command-panel").find("input[name=position]").val([e.position]),$(".player-command-panel").find("input[name=color]").not(".hex").val([e.color]),$(".player-command-panel").find("input[name=size]").val([e.size]),$(".player-command-panel").find("input.hex").removeClass("active"));var t,a=["naka"===e.position?null:e.position,"white"===e.color?null:e.color,"medium"===e.size?null:e.size];for(key in e.advanced)e.advanced[key]&&(key=184==key&&Nico.storage.current.player_setting_v2.comment_anonymity_post?null:key,a.push(key));t=a.filter(function(e){return null!==e}).join(" "),$(".player-command-input").val(t)},change:function(e){var t=this.normalization($(".player-command-input").val());e:for(key in this.regExp)switch(key){case"position":case"color":case"size":if(e.match(this.regExp[key])){t[key]=e;break e}break;case"advanced":t.advanced[e]=!0;break e}return t},normalization:function(e){var t=e.toLowerCase().split(/\s/).filter(function(e,t,a){return a.indexOf(e)===t&&e.length}),a={size:"medium",position:"naka",color:"white",advanced:{full:!1,patissier:!1,ender:!1,invisible:!1,184:Nico.storage.current.player_setting_v2.comment_anonymity_post}};e:for(var n=0;n<t.length;n++)for(key in this.regExp)switch(key){case"position":case"color":case"size":if(t[n].match(this.regExp[key])){a[key]=t[n];continue e}continue;case"advanced":a.advanced[t[n]]=!0;continue e}return a}},comment:{check:function(e,t,a){if(Nico.player.state.getflv){if(t+=" ncf",e=e.replace(/\s+$/,""),!e)return void console.warn("\u30b3\u30e1\u30f3\u30c8\u304c\u306a\u3044\u3088!");if(/^\s+$/.test(e))return void console.warn("\u7a7a\u767d\u6587\u5b57\u3060\u3051\u306e\u30b3\u30e1\u30f3\u30c8\u306f\u6295\u7a3f\u3067\u304d\u307e\u305b\u3093!");if(e.length>1024)return void console.warn("\u30b3\u30e1\u30f3\u30c8\u6587\u5b57\u6570\u304c\u9577\u904e\u304e\u307e\u3059!");if(e.length>75&&console.info("75\u6587\u5b57\u4ee5\u4e0a\u306e\u30b3\u30e1\u30f3\u30c8\u3092\u6295\u7a3f\u3057\u307e\u3059"),Nico.storage.current.player_setting_v2.comment_anonymity_post&&!/(\s|^)184(\s|$)/.test(t)&&(t+=" 184"),e.length>75&&/(\s|^)184(\s|$)/.test(t)&&(t=t.replace(/(\s184|184\s)/g,""),console.info("\u533f\u540d\u30b3\u30de\u30f3\u30c9\u306e\u89e3\u9664\u3092\u884c\u3044\u307e\u3057\u305f\u3002")),Nico.player.state.comment.lastSend===e)return void console.warn("\u540c\u3058\u30b3\u30e1\u30f3\u30c8\u3092\u9023\u7d9a\u3067\u6295\u7a3f\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093!");t=t.replace(/^\s+|\s+$/g,"").replace(/\s{2,}/," "),this.post(e,t,a)}},post:function(e,t,a){var n,r,o=~~(100*a),i=$.Deferred();Nico.api.requestMessageServer($("<packet>").append($("<thread>").attr({thread:DATA.getflv.thread_id,version:20090904,res_from:DATA.video.default_res}))).then(function(e){if(0==$(e).find("thread").attr("resultcode")){var t=~~($(e).find("thread").attr("last_res")/100);return n=$(e).find("thread").attr("ticket"),r=$(e).find("thread").attr("click_revision"),Nico.api.flGetRequest("getpostkey",{thread:DATA.getflv.thread_id,block_no:t,device:1,version:1,version_sub:2},"get")}return console.warn("Ticket\u306e\u53d6\u5f97\u306b\u5931\u6557\u3057\u305f\u305f\u3081\u3001\u6295\u7a3f\u51e6\u7406\u3092\u4e2d\u65ad\u3057\u307e\u3057\u305f"),i.reject()}).then(function(a){return postkey=Nico.fn.parse_str(a).postkey,postkey.length>0?Nico.api.requestMessageServer($("<chat>").attr({thread:DATA.getflv.thread_id,vpos:o,mail:t,ticket:n,user_id:DATA.getflv.user_id,postkey:postkey,premium:DATA.getflv.is_premium}).html(e)):(console.warn("PostKey\u306e\u53d6\u5f97\u306b\u5931\u6557\u3057\u305f\u305f\u3081\u3001\u6295\u7a3f\u51e6\u7406\u3092\u4e2d\u65ad\u3057\u307e\u3057\u305f"),i.reject())}).then(function(e){return Nico.player.comment.checkResult(+$(e).find("chat_result").attr("status"))?Nico.api.requestMessageServer($("<packet>").append($("<thread>").attr({thread:DATA.getflv.thread_id,version:20090904,res_from:$(e).find("chat_result").attr("no"),scores:1,nicoru:1,with_global:1,click_revision:r}))):i.reject()}).then(function(t){$(".player-comment-form").find("input[type=text]").val("");var a=t.querySelector("chat"),n=t.querySelector("view_counter"),r=t.querySelector("global_num_res"),o={video:{id:n.getAttribute("id"),thread:+r.getAttribute("thread"),view:+n.getAttribute("video"),mylist:+n.getAttribute("mylist"),comment:+r.getAttribute("num_res")},chat:{thread:+a.getAttribute("thread"),no:+a.getAttribute("no"),vpos:+a.getAttribute("vpos"),date:+a.getAttribute("date"),anonymity:+a.getAttribute("anonymity"),user_id:a.getAttribute("user_id"),content:a.innerHTML,mail:a.getAttribute("mail")?a.getAttribute("mail").split(" "):[],score:a.getAttribute("score")?+a.getAttribute("score"):0,nicoru:a.getAttribute("nicoru")?+a.getAttribute("nicoru"):0,deleted:a.getAttribute("deleted")?+a.getAttribute("deleted"):0,fork:a.getAttribute("fork")?!0:!1}};Nico.player.comment.sendLocalMessage(o),Nico.player.state.comment.lastSend=e,Nico.storage.put("comment_history",{thread:o.chat.thread,no:o.chat.no,vpos:o.chat.vpos,mail:o.chat.mail,user_id:o.chat.user_id,body:o.chat.content,date:o.chat.date})})},sendLocalMessage:function(e){switch(Nico.player.state.type){case"html5":if(!Player.html5)return;Player.watch.dispatchEvent(new CustomEvent("extensionSendLocalMessage",{detail:e}));break;case"flash":if(void 0===Player.flash.ext_getPlayheadTime)return;for(var t=0;t<e.length;t++)Player.flash.ext_sendLocalMessage(e[t].chat,e[t].mail,~~(e[t].vpos/100))}},checkResult:function(e){switch(e){case 0:return console.info("\u6295\u7a3f\u306b\u6210\u529f\u3057\u307e\u3057\u305f!"),!0;case 1:return console.warn("\u6295\u7a3f\u304c\u62d2\u5426\u3055\u308c\u307e\u3057\u305f"),!1;case 2:return console.warn("\u30b9\u30ec\u30c3\u30c9ID\u304c\u304a\u304b\u3057\u3044\u3088\u3046\u3067\u3059"),!1;case 3:return console.warn("\u6295\u7a3f\u30c1\u30b1\u30c3\u30c8\u304c\u304a\u304b\u3057\u3044\u3088\u3046\u3067\u3059"),!1;case 4:return console.warn("\u30dd\u30b9\u30c8\u30ad\u30fc\u304c\u304a\u304b\u3057\u3044\u3088\u3046\u3067\u3059"),!1;case 5:return console.warn("\u30b3\u30e1\u30f3\u30c8\u6295\u7a3f\u304c\u30d6\u30ed\u30c3\u30af\u3055\u308c\u3066\u3044\u307e\u3059"),!1;case 6:return console.warn("\u30b3\u30e1\u30f3\u30c8\u304c\u66f8\u304d\u8fbc\u3081\u307e\u305b\u3093\u3067\u3057\u305f"),!1;case 8:return console.warn("\u30b3\u30e1\u30f3\u30c8\u6587\u5b57\u6570\u304c\u9577\u3059\u304e\u3067\u3059"),!1;default:return console.warn("\u4f8b\u5916\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f"),!1}}}},Nico.api={flGetRequest:function(e,t,a){return a=a||"post",$.ajax({url:"http://flapi.nicovideo.jp/api/"+e+"/",type:a,dataType:"text",data:$.param(t)})},requestStoryboard:function(e,t){return $.ajax({url:e,type:"get",dataType:"xml",data:$.param(t)})},requestMessageServer:function(e){var t={url:DATA.getflv.ms,type:"post",dataType:"xml",contentType:"text/xml",data:$(e).get(0).outerHTML};return"http://nmsg.nicovideo.jp/api/"==DATA.getflv.ms&&(t.contentType="application/xml"),$.ajax(t)}},Nico.storage={current:{},init:function(e){localStorage.getItem(e)?this.current[e]=JSON.parse(localStorage.getItem(e)):this.current[e]=[]},set:function(e,t){var a=JSON.stringify($.extend(this.current[e],t));localStorage.setItem(e,a)},put:function(e,t){this.current[e].push(t),localStorage.setItem(e,JSON.stringify(this.current[e]))},remove:function(e,t){}},Nico.fn={chrome_storage:function(e,t){chrome.storage.local[e](t,function(e){chrome.runtime.error?console.error(chrome.runtime.error):console.log(e)})},parse_str:function(e){for(var t=e.split("&"),a={},n=0;n<t.length;n++){var r=t[n].split("=");a[r[0]]=decodeURIComponent(r[1])}return a},mscv:function(e){e=0>e?0:e;var t=e>=3600?this.zeroPad(~~(e/3600)):null,a=this.zeroPad(~~(e/60%60)),n=this.zeroPad(~~(e%60));return null!=t?t+":"+a+":"+n:a+":"+n},tscv:function(e){return e.getFullYear()+"/"+this.zeroPad(e.getMonth()+1)+"/"+this.zeroPad(e.getDate())+" "+this.zeroPad(e.getHours())+":"+this.zeroPad(e.getMinutes())+":"+this.zeroPad(e.getSeconds())},zeroPad:function(e){return 10>e?"0"+e:e}},$(function(){if(document.dispatchEvent(new CustomEvent("NicofinderExtension",{detail:!0})),/(www|dev|staging)\.nicofinder\.net/.test(window.location.hostname)&&/^\/(watch|player)\/(\d{10}|[a-z]{2}\d+)$/.test(window.location.pathname)){Nico.storage.init("comment_history"),Nico.storage.init("player_setting_v2");var observer=new MutationObserver(function(e){e.forEach(function(e){for(var t=0;t<e.addedNodes.length;t++)"html5-video"===e.addedNodes[t].id&&(Player.html5=document.querySelector("#html5-video"),observer.disconnect())})});observer.observe(document.querySelector("#player"),{childList:!0,subtree:!0}),window.addEventListener("DOMContentLoaded",function(){return eval($("#watch-data").html()),1===wd.version?!1:(DATA=Data,void Nico.player.init())},!1)}});