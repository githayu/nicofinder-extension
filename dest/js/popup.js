var Popup={state:{},init:function(){chrome.tabs.query({active:!0},function(e){for(var t,i=0;i<e.length;i++){if(t=e[i].url.match(Nicofinder.Define.Regexp.Views))return void chrome.runtime.sendMessage({get:["type","id"]},function(e){Popup.state.type=t[2],Popup.state.id=t[3],t[2]===e.type&&t[3]===e.id,Popup.view()});Popup.view()}}),chrome.storage.local.get({redirect:!1},function(e){e.redirect&&$("#setting").find(".redirect").find(".toggle").addClass("on no-anime")}),$("#setting").find(".redirect").find(".toggle").click(function(){var e=this;$(this).removeClass("no-anime"),$(this).hasClass("on")?chrome.storage.local.set({redirect:!1},function(){$(e).removeClass("on")}):chrome.storage.local.set({redirect:!0},function(){$(e).addClass("on")})}),$("#action").on("click",".trigger",function(){Popup.redirector([Nicofinder.Define.Host.URL,this.dataset.action,Popup.state.id].join("/"),this.dataset.tab)}),$("#container").find(".nicofinder-link").click(function(){Popup.redirector(Nicofinder.Define.Host.URL)})},view:function(){function e(e){var t=new $.Deferred,i=new Image;return i.src=e,$(i).on("error",function(){t.resolve(!1)}).on("load",function(){t.resolve(!0)}),t.promise()}function t(e,t){$("#thumbnail").css({"background-image":"url("+e+")"}).addClass(t).show()}var i=function(e,t,i){var i=i||"current";$("#action").append($("<li>").addClass([e,"trigger"].join(" ")).text(t).attr({"data-action":e,"data-tab":i}))};switch(this.state.type){case"watch":var n,r=new $.Deferred;Nicofinder.request.getthumbinfo(Popup.state.id).then(function(e){return n=e,"ok"==$(n).attr("status")?r.resolve():(t("http://res.nimg.jp/img/common/video_deleted_ja-jp.jpg","deleted"),r.reject())}).then(function(){return e($(n).find("thumbnail_url").text()+".L")}).then(function(e){e?t($(n).find("thumbnail_url").text()+".L"):t($(n).find("thumbnail_url").text(),"small")}),i("watch","Nicofinder\u3067\u8996\u8074"),i("comment","\u30b3\u30e1\u30f3\u30c8\u3092\u89e3\u6790","new");break;case"mylist":i("mylist","Nicofinder\u3067\u95b2\u89a7")}},redirector:function(e,t){switch(t){case"new":chrome.tabs.create({url:e});break;default:chrome.tabs.update(null,{url:e}),window.close()}}};Popup.init();